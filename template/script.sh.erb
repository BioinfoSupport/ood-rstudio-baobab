#!/usr/bin/env bash

set -x

workdir="<%= session.staged_root %>"
mkdir -p -m 700 ${workdir}/run ${workdir}/tmp ${workdir}/log ${workdir}/var/lib/rstudio-server

cat > ${workdir}/logging.conf <<END
[*]
log-level=debug
logger-type=file
log-dir=/log
END

#--bind "${workdir}/logging.conf:/etc/rstudio/logging.conf" \
singularity exec \
    --cleanenv \
    --env OMP_NUM_THREADS=<%= context.cpus_core %> \
    --env RSTUDIO_SESSION_TIMEOUT=0 \
    --env USER=$(id -un) \
    --env PASSWORD=${RSTUDIO_PASSWORD} \
    --bind "${workdir}/run:/run" \
    --bind "${workdir}/tmp:/tmp" \
    --bind "${workdir}/log:/log" \
    --bind "${workdir}/var/lib/rstudio-server:/var/lib/rstudio-server" \
    ~/scratch/ngs.sif \
      /usr/lib/rstudio-server/bin/rserver \
        --www-port=${port} \
        --auth-none=0 \
        --auth-pam-helper-path=${workdir}/bin/auth \
        --auth-encrypt-password=0 \
        --auth-stay-signed-in-days=2 \
        --auth-timeout-minutes=0 \
        --server-user="$USER"






