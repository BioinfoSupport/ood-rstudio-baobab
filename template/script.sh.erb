#!/usr/bin/env bash

set -x

workdir="<%= session.staged_root %>"
mkdir -p -m 700 ${workdir}/run ${workdir}/var/lib/rstudio-server

singularity exec \
    --cleanenv \
    --env OMP_NUM_THREADS=<%= context.cpus_core %> \
    --env RSTUDIO_SESSION_TIMEOUT=0 \
    --env USER="$(id -un)" \
    --env PASSWORD="${password}" \
    --bind "/scratch:/tmp" \
    --bind "${workdir}/run:/run" \
    --bind "${workdir}/var/lib/rstudio-server:/var/lib/rstudio-server" \
    ~/scratch/ngs.sif \
    rserver \
        --www-port=${port} \
        --server-user="$USER"

